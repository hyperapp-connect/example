{"version":3,"file":"server.js","sources":["../../hyperconnect-client/src/ws.js"],"sourcesContent":["let ws = undefined\n\nexport const cache = []\nexport let open = false\nexport let apiVersion = \"v0\"\n\nlet error = (...msg) => console.error(...msg)\n\nconst isString = o => typeof o === \"string\"\nconst isFunction = o => typeof o === \"function\"\n\nconst stringify = msg => {\n  try {\n    if (isString(msg)) {\n      msg = JSON.parse(msg)\n    }\n\n    msg[0] = `${apiVersion}.${msg[0]}`\n\n    return JSON.stringify(msg)\n  } catch (e) {\n    error(e)\n  }\n}\n\nconst parse = msg => {\n  if (!isString(msg)) {\n    return msg\n  }\n\n  try {\n    return JSON.parse(msg)\n  } catch (e) {\n    return msg\n  }\n}\n\nconst reactions = actions => ({\n  onmessage: e => {\n    if (e.data === \"Unknown Action\") {\n      error(\"Unknown Action\", e)\n      return\n    }\n\n    const [path, data] = parse(e.data)\n    let action = actions\n\n    path.split(\".\").forEach(key => {\n      const fnName = `${key}_done`\n      const sub = action[fnName]\n      if (isFunction(sub)) {\n        action = sub\n        return\n      } else {\n        action = actions[key]\n      }\n    })\n\n    if (isFunction(action)) {\n      return action(data)\n    }\n  },\n  open: () => {\n    open = true\n\n    while (cache.length) {\n      const msg = cache.shift()\n      ws.send(stringify(msg))\n    }\n  },\n  close: () => {\n    open = false\n  }\n})\n\nexport const connect = (actions, options = {}) => {\n  const host = options.host || location.hostname\n  const port = options.port || location.port\n  const protocol = options.protocol || \"ws\"\n\n  apiVersion = options.apiVersion || \"v0\"\n  error = options.error || error\n\n  if (!ws) {\n    ws = new WebSocket(`${protocol}://${host}:${port}`)\n    open = false\n  }\n\n  const react = reactions(actions)\n\n  ws.onopen = react.open\n  ws.onclose = react.close\n  ws.onmessage = react.onmessage\n\n  return ws\n}\n\nexport const send = msg => (open ? ws.send(stringify(msg)) : cache.push(msg))\n\nexport default connect\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}